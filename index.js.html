<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file index.js
 * @project trashcan
 * @license GPLv3.
 * @copyright 2015 Online Health Database.
 */

"use strict";

var rc = require('rc')
  , events = new (require('events').EventEmitter)
  , nodemailer = require('nodemailer')
  , timestamp = function (msg) {
      return '[' + (new Date) + '] ' + msg
    }
  , tc = function (fn, context) {
      context = context || tc

      var handle = function (error) {
        if (error) {
          tc.throw(error)
        } else {
          var args = Array.prototype.slice.call(arguments, 1)
          return fn.apply(context, args)
        }
      }

      handle.exec = function () {
        try {
          fn.apply(context, arguments)
        } catch (error) {
          tc.throw(error)
        }
      }

      return handle
    }
  , prototype = {

      /**
       * Attach an event listener.
       * @public
       * @method on
       * @params {String} event - the event to attach to
       * @params {Function} callback - an event handler
       */
      on: function () {
        events.on.apply(events, arguments)
        return tc
      }

      /**
       * Detach an event listener.
       * @public
       * @method off
       * @params {String} event - the event to detach from
       * @params {Function} callback - an event handler
       */
    , off: function () {
        events.off.apply(events, arguments)
        return tc
      }

      /**
       * Emit an event.
       * @public
       * @method emit
       * @params {String} event - the event to emit
       * @params {Variant} data - some data to pass
       */
    , emit: function () {
        events.emit.apply(events, arguments)
        return tc
      }

      /**
       * Expand an error into its full form (with extra details).
       * @public
       * @method full
       * @params {String} error - an error message
       * @returns {String} message - an expanded error message
       */
    , full: function (error) {
        return JSON.stringify({
            error: error
          , freemem: 0
        }, null, 2)
      }

      /**
       * Throw an error safely.
       * @public
       * @method throw
       * @params {Error|String} error - the error to throw
       */
    , throw: function (error) {
        this.emit('error', error)
        return tc
      }

      /**
       * Create a callback for logging errors to a file.
       * @public
       * @method log
       * @params {String} filename - the file to log to
       * @returns {Function} callback - the callback to aattach to the error event
       */
    , log: function (filename) {
        var self
        fs.writeFileSync(filename, timestamp('Error log started.') + '\n')

        /** simply append all error info to the file */
        return (self = function (error) {
          fs.appendFile(filename, timestamp(tc.full(error)) + '\n')
          return self
        })
      }

      /**
       * Create a callback for sending errors as emails.
       * @public
       * @method notify
       * @params {Array|String} email(s) - the email address(es) to notify
       * @returns {Function} callback - the callback to attach to the error event
       */
    , notify: function (emails, config) {
        var self, transport

        // prefer arrays
        if (typeof emails === 'string') emails = [emails]

        // try loading mail configuration
        if (!config) config = rc('mail', {})

        // create a nodemailer transporter
        transport = nodemailer.createTransport(config)

        /** use nodemailer to transport a full notification */
        return (self = function (error) {
          transport.sendMail({
              to: emails
            , from: config.auth.user
            , subject: String(error)
            , text: tc.full(error)
            , html: '&lt;code>&lt;pre>' + tc.full(error) + '&lt;/pre>&lt;/code>'
          })
  
          return self
        })
      }

      /**
       * Handle rejections of a promise.
       * @public
       * @method swear
       * @params {Promise} promise - a promise object work handle for
       * @params {Function} callback - a success callback to execute on resolution
       */
    , swear: function (promise, success) {
        promise.then(success, tc.throw)
        return tc
      }

      /**
       * Catch all error events of an emitter.
       * @public
       * @method catch
       * @params {EventEmitter} emitter - the event emitter/object to catch errors from
       */
    , catch: function (emitter) {
        emitter.on('error', tc.throw)
        return tc
      }

    }
  , i

// also handle uncaught exceptions
process.on('uncaughtException', function (error) {
  tc.throw(error)
})

// expand prototype onto function
for (i in prototype) {
  if (prototype.hasOwnProperty(i)) {
    tc[i] = prototype[i]
  }
}

/** @module trashcan */
module.exports = tc
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-trashcan.html">trashcan</a></li></ul><h3>Global</h3><ul><li><a href="global.html#catch">catch</a></li><li><a href="global.html#emit">emit</a></li><li><a href="global.html#full">full</a></li><li><a href="global.html#log">log</a></li><li><a href="global.html#notify">notify</a></li><li><a href="global.html#off">off</a></li><li><a href="global.html#on">on</a></li><li><a href="global.html#swear">swear</a></li><li><a href="global.html#throw">throw</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-beta3</a> on Fri Apr 24 2015 10:11:19 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
